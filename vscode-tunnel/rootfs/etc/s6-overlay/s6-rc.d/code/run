#!/usr/bin/with-contenv bashio

name=$(bashio::config 'name')
ghLogin=$(bashio::config 'ghLogin')
doTail=$(bashio::config 'tail')

bashio::log.green "Name: '$name', GitHub Login: $ghLogin"

checkDir () {
    if [ ! -d "$1" ]; then
        bashio::log.warning "Directory $1 does not exist. Creating..."
        mkdir -p "$1"
    fi
}

checkDir "/config"
checkDir "/config/cli"
checkDir "/code"
checkDir "~/.vscode"

if [ ! -L "~/.vscode/cli" ]; then
    bashio::log.green "Creating ~/.vscode/cli symlink"
    ln -s /config/cli ~/.vscode/
fi

if [ ! -L "/code/WORKSPACE" ]; then
    bashio::log.green "Creating /code/WORKSPACE symlink"
    ln -s /config/WORKSPACE /code/
fi

args=""

if ["$ghLogin" = "true"]; then
    args="github"
else
    args="microsoft"
fi

if [ ! -f "/config/cli/token.json"]; then
    bashio::log.green "No token found, initiating log in with type: $args"
    /code/.code tunnel user login --provider $args
fi

if ["$name" = ""]; then
    args="--random-name"
else
    args="--name $name"
fi

bashio::log.green "Starting VSCode Tunnel with args: $args"

tmux new-session -d -s vscode "/code/.code tunnel --accept-server-license-terms $args > /tmp/log.txt 2>&1; tmux wait-for -S done"

if ["$doTail" = "true"]; then
    bashio::log.green "Attaching to log"
    tail -f /tmp/log.txt
else
    bashio::log.green "Not attaching to log"
    tmux wait-for done
fi